<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ddar::abstract_crypto Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head><div id="headerLeft">
<body>
<div id="top"><!-- do not remove this div! -->

<div id="titlearea">
<table cellspacing="0" cellpadding="0" height="68">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td id="projectlogo"><a href="http://www.samsung.com"><img width="80" height="48" alt="Logo" src="samsung.jpg"></a></td>
  
  
  
  <td style="padding-left: 0.5em;"> <div id="projectname">Mobile Device Management </div> </td>
  
  
  
  <td style="padding-left: 0.5em;"> &#160;<div id="projectbrief">Native SDK</div> </td>
  
  
  
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><b>ddar</b>      </li>
      <li class="navelem"><a class="el" href="classddar_1_1abstract__crypto.html">abstract_crypto</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="classddar_1_1abstract__crypto.html#pub-methods">Public Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">ddar::abstract_crypto Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="ddar::abstract_crypto" -->
<p>Base class for dual-dar crypto implementation.  
 <a href="classddar_1_1abstract__crypto.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="ddar_8h_source.html">ddar.h</a>&gt;</code></p>

<p><a href="classddar_1_1abstract__crypto-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classddar_1_1abstract__crypto.html#a1f1a4d550c0840b4e04bc6d6129a0f13">prepare</a> (<a class="el" href="classddar_1_1context.html">context</a> *<a class="el" href="classddar_1_1context.html">context</a>, <a class="el" href="classddar_1_1metadata.html">metadata</a> *md)=0</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Callback to initialize ephemeral cache.  <a href="classddar_1_1abstract__crypto.html#a1f1a4d550c0840b4e04bc6d6129a0f13"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classddar_1_1abstract__crypto.html#a17eef7aebf0ef97684af036b657a9947">encrypt</a> (<a class="el" href="classddar_1_1metadata.html">metadata</a> *md, void *pt, void *ct, unsigned long page_offset, int page_len)=0</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Callback when a file is currently being written to the disk.  <a href="classddar_1_1abstract__crypto.html#a17eef7aebf0ef97684af036b657a9947"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classddar_1_1abstract__crypto.html#aaaf5ca9de70bf1b902cecc72049653b8">decrypt</a> (<a class="el" href="classddar_1_1metadata.html">metadata</a> *md, void *ct, unsigned long page_offset, int page_len)=0</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Callback when a file is currently being read from the disk.  <a href="classddar_1_1abstract__crypto.html#aaaf5ca9de70bf1b902cecc72049653b8"></a><br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Base class for dual-dar crypto implementation. </p>
<p>A derived class must override all the public virtual functions. Crypto module must have an entry symbol DDAR_ABSTRACT_CRYPTO_SYM with a type of <a class="el" href="classddar_1_1abstract__crypto.html" title="Base class for dual-dar crypto implementation.">abstract_crypto</a> then the system daemon can dynamically load the derived class at device boot up</p>
<pre>
 MyTestCrypto.cpp
 MyTestCrypto DDAR_ABSTRACT_CRYPTO_SYM;
 </pre><p>When <a class="el" href="classddar_1_1abstract__crypto.html" title="Base class for dual-dar crypto implementation.">abstract_crypto</a> callbacks are invoked?</p>
<ul>
<li>First encrypt/decrypt after inode object allocation When inode object is allocated in the kernel, ephemeral cache is empty. Then the next encrypt or decrypt operation requested to dualdar daemon, it invoke <a class="el" href="classddar_1_1abstract__crypto.html#a1f1a4d550c0840b4e04bc6d6129a0f13" title="Callback to initialize ephemeral cache.">abstract_crypto::prepare()</a>. In the prepare function, all the initialization logic should be performed that should happen only once for the inode object's lifetime (until inode invalidation). For example, an implementation of prepare might derive file encryption key (FEK) from the master key in secret object and store the FEK in ephemeral cache to further use it within encrypt/decrypt callbacks</li>
<li>Writeback (delayed disk I/O): <a class="el" href="classddar_1_1abstract__crypto.html#a17eef7aebf0ef97684af036b657a9947" title="Callback when a file is currently being written to the disk.">abstract_crypto::encrypt()</a> is called while (right before) dirty pages are written out to disk dirty page writeback occurs in three situations:<ul>
<li>Memory pressure. when free memory shrinks below a specific threshold (dirty_background_ratio)</li>
<li>Timer. When dirty grows older than a specific period (to avoid remain dirty indefinitely). Flusher threads periodically wake up (unrelated to low-memory condition) and writes out old dirty pages</li>
<li>sync() and fsync() system-calls when user process invokes them, the kernel performs write-back on demand. Some of c++/Java methods internally call fsync()</li>
</ul>
</li>
<li>Readahead: <a class="el" href="classddar_1_1abstract__crypto.html#aaaf5ca9de70bf1b902cecc72049653b8" title="Callback when a file is currently being read from the disk.">abstract_crypto::decrypt()</a> is called by a user process' read() system call and the file content is not yet loaded in memory</li>
</ul>
<p>Data lock state: When Android framework decides to trigger user state transition into data lock state, it executes as follows</p>
<ul>
<li>Clear all secret object associated with the user. The memory space for each secret object is cleared by overwritting with zeros (NIAP, FCS_CKM_EXT.4, Cryptographic Key Destruction)</li>
<li>Secure inode object invalidation:<ul>
<li>Immediately flush dirty pages into disk blocks</li>
<li>Free page caches connected to each inode object. Data contents in each page is cleared from memory by overwritting with zeros</li>
<li>Ephemeral cache page is cleared by overwritting with zeros and freed to memory pool</li>
<li>Free inode object</li>
</ul>
</li>
<li>inode invalidation is triggered in following cases:<ul>
<li>In data lock state, all the inode object within the user are invalidated</li>
<li>File deletion</li>
<li>Memory pressue (page frame reclamation), the kernel select old pages (based on Least-Recently Used list) which can freed for new uses before physical memory is exhausted</li>
</ul>
</li>
</ul>
<p>Declaring library version: Crypto library shall declare library version by defining a symbol DDAR_ABSTRACT_CRYPTO_VERSION This version string is exposed to Java interface DualDARPlatformInfo.clientLibVersion.</p>
<pre>
 MyTestCrypto.cpp
 const unsigned char *DDAR_ABSTRACT_CRYPTO_VERSION = "1.0.1";  // &lt;major&gt;.&lt;minor&gt;.&lt;patch&gt;
 </pre> </div><hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="aaaf5ca9de70bf1b902cecc72049653b8"></a><!-- doxytag: member="ddar::abstract_crypto::decrypt" ref="aaaf5ca9de70bf1b902cecc72049653b8" args="(metadata *md, void *ct, unsigned long page_offset, int page_len)=0" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">virtual bool <a class="el" href="classddar_1_1abstract__crypto.html#aaaf5ca9de70bf1b902cecc72049653b8">ddar::abstract_crypto::decrypt</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classddar_1_1metadata.html">metadata</a> *&#160;</td>
          <td class="paramname"><em>md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>ct</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>page_offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>page_len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [pure virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Callback when a file is currently being read from the disk. </p>
<p>The source and destination pages are same, sub classes are expected to implement an inplace decryption</p>
<pre>
 bool MyTestCrypto::decrypt(ddar::metadata *md, void *ct, unsigned long page_offset, int page_len) {
  struct my_metadata *my_md = (struct my_metadata *) md-&gt;ephemeral_addr;</pre><pre>  if(mSSL.decrypt((unsigned char *)ct, page_len,
          (unsigned char *)my_md-&gt;fek, NULL,
          (unsigned char *)ct) &gt; 0)  // implement crypto inplace
      return true;
  return false;
 }
 </pre><dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">ct</td><td>source and destination page of kernel memory that contains cipher text from the disk </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a17eef7aebf0ef97684af036b657a9947"></a><!-- doxytag: member="ddar::abstract_crypto::encrypt" ref="a17eef7aebf0ef97684af036b657a9947" args="(metadata *md, void *pt, void *ct, unsigned long page_offset, int page_len)=0" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">virtual bool <a class="el" href="classddar_1_1abstract__crypto.html#a17eef7aebf0ef97684af036b657a9947">ddar::abstract_crypto::encrypt</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classddar_1_1metadata.html">metadata</a> *&#160;</td>
          <td class="paramname"><em>md</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>pt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>ct</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>page_offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>page_len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [pure virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Callback when a file is currently being written to the disk. </p>
<pre>
 bool MyTestCrypto::encrypt(ddar::metadata *md, void *pt, void *ct, unsigned long page_offset, int page_len) {
  struct my_metadata *my_md = (struct my_metadata *) md-&gt;ephemeral_addr;</pre><pre>  if(mSSL.encrypt((unsigned char *)pt, page_len,
          (unsigned char *)my_md-&gt;fek, NULL,
          (unsigned char *)ct) &gt; 0)
      return true;
  return false;
 }
 </pre><dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">pt</td><td>source filesystem page cache that contains plain text from user program </td></tr>
    <tr><td class="paramname">ct</td><td>destination page of kernel memory that is being written to the disk </td></tr>
    <tr><td class="paramname">page_offset</td><td>page into the associated file </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a1f1a4d550c0840b4e04bc6d6129a0f13"></a><!-- doxytag: member="ddar::abstract_crypto::prepare" ref="a1f1a4d550c0840b4e04bc6d6129a0f13" args="(context *context, metadata *md)=0" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">virtual bool <a class="el" href="classddar_1_1abstract__crypto.html#a1f1a4d550c0840b4e04bc6d6129a0f13">ddar::abstract_crypto::prepare</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classddar_1_1context.html">context</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classddar_1_1metadata.html">metadata</a> *&#160;</td>
          <td class="paramname"><em>md</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [pure virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Callback to initialize ephemeral cache. </p>
<p>This is called when first encryption/decryption after inode object allocation</p>
<pre>
 bool MyTestCrypto::prepare(ddar::context *context, ddar::metadata *md) {
  <a class="el" href="classddar_1_1secret.html" title="Pair of alias/data pair created by the platform.">ddar::secret</a> *sec = context-&gt;get_secret("my_master_key_alias");  # vendor client app defined
  struct my_metadata *my_md = (struct my_metadata *) md-&gt;ephemeral_addr;</pre><pre>  char *iv = NULL;
  char efek[FEK_KEYLEN];</pre><pre>  int rc = md-&gt;persistent_get(ALIAS_EFEK, efek);
  if (rc &lt;= 0) {
      // No FEK associate with the file, create new
      mSSL.rand_bytes(my_md-&gt;fek, FEK_KEYLEN);
      rc = mSSL.encrypt((unsigned char *)my_md-&gt;fek, FEK_KEYLEN,
              (unsigned char *)sec-&gt;data, (unsigned char *)iv, (unsigned char *)efek);
      if (rc &lt; 0)
          return false;  // failed to encrypt efek</pre><pre>      md-&gt;persistent_set(ALIAS_EFEK, efek, FEK_KEYLEN);  // store efek
  } else {
      mSSL.decrypt((unsigned char *)efek, rc,
          (unsigned char *)sec-&gt;data, (unsigned char *)iv, (unsigned char *)my_md-&gt;fek);
  }
  </pre><dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">context</td><td>access user-wide global info </td></tr>
    <tr><td class="paramname">md</td><td>metadata to access per-file info </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>dualdar/<a class="el" href="ddar_8h_source.html">ddar.h</a></li>
</ul>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Samsung Electronics. SDK @MDM_VERSION@ - Sun Nov 15 2020 </small></address>

</body>
</html>
